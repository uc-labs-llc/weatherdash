<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Weather Platform</title>
<link rel="stylesheet"href="css/iot_tester.css">   
<link rel="stylesheet"href="css/styles.css">
<link rel="stylesheet"href="css/sprinklers.css">  
<link rel="icon" type="image/x-icon" href="favicon.ico">
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <style>
        /* Custom styles for the dark theme and LED status */
        .led-off {
            color: #d1d5db; /* Gray */
            text-shadow: none;
        }
        .led-on-green {
            color: #10b981; /* Green */
            text-shadow: 0 0 5px rgba(16, 185, 129, 0.7);
        }
        .led-on-blue {
            color: #3b82f6; /* Blue */
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.7);
        }
        .led-on-yellow {
            color: #f59e0b; /* Yellow/Amber */
            text-shadow: 0 0 5px rgba(245, 158, 11, 0.7);
        }
    </style>

</head>
<body class="bg-gray-800 flex items-center justify-center min-h-screen p-4">
  <div class="container">

<div class="sidebar">
  <img src="images/notb.png" alt="Logo" class="sidebar-logo">
<a href="index.html" class="nav-item" data-page="home">
    <span>HOME</span>
  </a>
  <a href="con-sites.html" class="nav-item" data-page="page2">
    <span>CON-SITES</span>
  </a>
  <a href="satellites.html" class="nav-item" data-page="page3">
    <span>SATELLITE</span>
  </a>
  <a href="suntracker.html" class="nav-item" data-page="page4">
    <span>SunTracker</span>
  </a>
<a href="moontracker.html" class="nav-item" data-page="page5">
    <span>MoonTracker</span>
  </a>
<a href="irrigation.html" class="nav-item" data-page="page6">
    <span>Irrigation</span>
  </a>
<a href="iot_tester.html" class="nav-item" data-page="page7">
    <span>API END POINT</span>
  </a>
<a href="solar-calc.html" class="nav-item" data-page="page8">
    <span>Solar CALC</span>
  </a>


</div>


<div class="max-w-full w-full mx-auto mb-6">        
<div id="info">
            <h2>API Weather Platform</h2>
            <div class="clock-container">
                <div id="time">
                    <div class="circle" style="--color: #0096FF">
                        <div class="dots h_dot"></div>
                        <svg>
                            <circle cx="35" cy="35" r="35"></circle>
                            <circle cx="35" cy="35" r="35" id="hh"></circle>
                        </svg>
                        <div id="hours">00</div>
                    </div>
                    <div class="circle" style="--color: #0096FF">
                        <div class="dots m_dot"></div>
                        <svg>
                            <circle cx="35" cy="35" r="35"></circle>
                            <circle cx="35" cy="35" r="35" id="mm"></circle>
                        </svg>
                        <div id="minutes">00</div>
                    </div>
                    <div class="circle" style="--color: #0096FF">
                        <div class="dots s_dot"></div>
                        <svg>
                            <circle cx="35" cy="35" r="35"></circle>
                            <circle cx="35" cy="35" r="35" id="ss"></circle>
                        </svg>
                        <div id="seconds">00</div>
                    </div>
                    <div class="ap">
                        <div id="ampm">AM</div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">Day/Night Progress (Texas)</div>
                    <div class="progress-bar">
                        <div class="night-segment" id="night"></div>
                        <div class="day-segment" id="day"></div>
                    </div>
                    <div class="progress-info">
                        <span id="night-text">Night</span>
                        <span id="day-text">Day</span>
                    </div>
                </div>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>
            <script src="js/clock.js"></script>
        </div>
    </div>

    <div class="max-w-6xl w-full mx-auto bg-gray-900 p-8 rounded-xl shadow-2xl border border-gray-700">
        
        <h2 class="text-3xl font-extrabold mb-6 text-white text-center">
           IoT Systems Tester
        </h2>
        
        <div class="mb-8 text-center">
            <button id="toggle-test-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 w-full text-lg">
                Start API Test
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            
            <div class="p-6 border border-gray-700 rounded-lg bg-gray-800">
                <h3 class="text-xl font-bold mb-3 text-white">
                    <i class="fas fa-fan text-green-500 mr-2"></i> Greenhouse Fan System (Alerts on: ON)
                </h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Current Temperature</p>
                        <p class="text-2xl font-semibold mt-1">
                            <span id="current-temp" class="text-blue-400">--</span><span class="text-gray-400">°F</span>
                        </p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg flex flex-col justify-between">
                        <label for="fan-threshold-input" class="text-sm text-gray-400">Fan Threshold (°F)</label>
                        <div class="flex items-baseline">
                            <input type="number" id="fan-threshold-input" value="85" min="50" max="120" step="1" 
                                class="bg-gray-900 text-red-400 text-2xl font-semibold w-24 p-1 rounded focus:ring-red-500 focus:border-red-500 border-gray-600">
                            <span class="text-gray-400 text-2xl font-semibold ml-1">°F</span>
                        </div>
                    </div>
                </div>
                <div class="p-3 border border-gray-600 rounded-lg bg-gray-700 flex items-center justify-between">
                    <p class="font-medium text-gray-300 text-lg">FAN Status:</p>
                    <span id="fan-status" class="text-xl font-bold led-off">OFF</span>
                </div>
            </div>

            <div class="p-6 border border-gray-700 rounded-lg bg-gray-800">
                <h3 class="text-xl font-bold mb-3 text-white">
                    <i class="fas fa-tint text-blue-500 mr-2"></i> Irrigation System (Alerts on: ON)
                </h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Current Rainfall (1h)</p>
                        <p class="text-2xl font-semibold mt-1">
                            <span id="current-rainfall" class="text-blue-400">--</span><span class="text-gray-400"> in.</span>
                        </p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg flex flex-col justify-between">
                        <label for="sprinkler-threshold-input" class="text-sm text-gray-400">Stop Threshold (in.)</label>
                        <div class="flex items-baseline">
                            <input type="number" id="sprinkler-threshold-input" value="0.50" min="0" max="5" step="0.01"
                                class="bg-gray-900 text-blue-400 text-2xl font-semibold w-24 p-1 rounded focus:ring-blue-500 focus:border-blue-500 border-gray-600">
                            <span class="text-gray-400 text-2xl font-semibold ml-1">in.</span>
                        </div>
                    </div>
                </div>
                <div class="p-3 border border-gray-600 rounded-lg bg-gray-700 flex items-center justify-between">
                    <p class="font-medium text-gray-300 text-lg">SPRINKLER Status:</p>
                    <span id="sprinkler-status" class="text-xl font-bold led-off">OFF</span>
                </div>
            </div>

            <div class="p-6 border border-gray-700 rounded-lg bg-gray-800">
                <h3 class="text-xl font-bold mb-3 text-white">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i> Greenhouse Light System
                </h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Sunrise Time</p>
                        <p class="text-xl font-semibold mt-1 text-yellow-300" id="sunrise-time">--:-- AM</p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Sunset Time</p>
                        <p class="text-xl font-semibold mt-1 text-red-400" id="sunset-time">--:-- PM</p>
                    </div>
                </div>
                <div class="p-3 border border-gray-600 rounded-lg bg-gray-700 flex items-center justify-between">
                    <p class="font-medium text-gray-300 text-lg">LIGHT Status:</p>
                    <span id="light-status" class="text-xl font-bold led-off">OFF</span>
                </div>
            </div>

        </div>
        <h3 class="text-lg font-semibold mb-2 text-gray-300">Transaction Log:</h3>
        <textarea id="log-output" class="w-full h-40 p-3 border border-gray-600 rounded-md text-sm font-mono bg-gray-900 text-green-400 resize-none" readonly>System ready. Press "Start API Test" to begin OpenWeatherMap & Mockoon/Beeceptor API CALL. Light system is controlled by live Sunrise/Sunset times.</textarea>
        
        <p class="text-xs text-gray-500 mt-3 text-center">
            OpenWeatherMap (Weather & Solar) calls are primary. Mockoon/Beeceptor (IoT API) calls are secondary.
        </p>
    </div>

    <script>
        // --- CONFIGURATION ---
        
        // OpenWeatherMap Configuration for Los Ebanos, Texas
        const OPENWEATHER_API_KEY = '';
        const OPENWEATHER_LAT = 26.2440;
        const OPENWEATHER_LON = -98.5553;
        const UNITS = 'imperial'; 

        const WEATHER_API_URL = `https://api.openweathermap.org/data/2.5/weather?lat=${OPENWEATHER_LAT}&lon=${OPENWEATHER_LON}&units=${UNITS}&appid=${OPENWEATHER_API_KEY}`;
        
        // Mockoon/IoT API calls
        const BASE_URL = 'http://localhost:8080'; 
        // CRITICAL: Change this to the URL of your PHP server (e.g., http://192.168.1.100 or http://localhost:80)
        const PHP_SERVER_URL = 'http://localhost/dash-email'; 

        const FAN_URL = `${BASE_URL}/api/fan-control`; 
        const SPRINKLER_URL = `${BASE_URL}/api/sprinkler-control`;
        const LIGHT_URL = `${BASE_URL}/api/light-control`; // NEW API ENDPOINT
        const EMAIL_HANDLER_URL = `${PHP_SERVER_URL}/send_iot_email.php`; 

        const CHECK_INTERVAL = 5000; // 5 seconds
        
        // Conversion constant: 1 millimeter = 0.03937 inches
        const MM_TO_INCH = 0.03937;

        // DOM Elements
        const currentTempEl = document.getElementById('current-temp');
        const fanStatusEl = document.getElementById('fan-status');
        const currentRainfallEl = document.getElementById('current-rainfall');
        const sprinklerStatusEl = document.getElementById('sprinkler-status');
        const logOutputEl = document.getElementById('log-output');
        const toggleButton = document.getElementById('toggle-test-btn'); 
        
        // THRESHOLD INPUT ELEMENTS
        const fanThresholdInputEl = document.getElementById('fan-threshold-input');
        const sprinklerThresholdInputEl = document.getElementById('sprinkler-threshold-input');

        // NEW LIGHT ELEMENTS
        const sunriseTimeEl = document.getElementById('sunrise-time');
        const sunsetTimeEl = document.getElementById('sunset-time');
        const lightStatusEl = document.getElementById('light-status');


        let fanState = 'OFF';           
        let sprinklerState = 'OFF';     
        let lightState = 'OFF';         // NEW STATE VARIABLE
        let intervalId = null;          

        // --- UTILITY FUNCTIONS ---

        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            let logMessage = `[${timestamp}] ${message}`;
            
            if (isError) {
                logMessage = `🚨 ERROR: ${logMessage}`;
            }

            logOutputEl.value += `\n${logMessage}`;
            logOutputEl.scrollTop = logOutputEl.scrollHeight;
        }

        function updateFanStatusDisplay(state) {
            fanStatusEl.textContent = state;
            fanStatusEl.classList.toggle('led-on-green', state === 'ON');
            fanStatusEl.classList.toggle('led-off', state === 'OFF');
        }

        function updateSprinklerStatusDisplay(state) {
            sprinklerStatusEl.textContent = state;
            sprinklerStatusEl.classList.toggle('led-on-blue', state === 'ON');
            sprinklerStatusEl.classList.toggle('led-off', state === 'OFF');
        }

        // NEW: Update Light Status Display
        function updateLightStatusDisplay(state) {
            lightStatusEl.textContent = state;
            lightStatusEl.classList.toggle('led-on-yellow', state === 'ON');
            lightStatusEl.classList.toggle('led-off', state === 'OFF');
        }
        
        // --- EMAIL ALERT FUNCTION ---
        function sendEmailAlert(device, status, message) {
            log(`EMAIL: Attempting to send alert for ${device} status: ${status}...`);
            
            fetch(EMAIL_HANDLER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    device: device,
                    status: status,
                    message: message 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    log(`EMAIL: Success. ${data.message}`);
                } else {
                    log(`EMAIL: Failed. ${data.message}`, true);
                }
            })
            .catch(error => {
                log(`EMAIL: Network Error calling PHP handler: ${error.message}. (Ensure PHP server is running on ${PHP_SERVER_URL} and 'send_iot_email.php' is accessible)`, true);
            });
        }
        // ---------------------------------


        // --- API CALL FUNCTIONS ---

        function sendFanCommand(state, temp) {
            const tempThreshold = parseFloat(fanThresholdInputEl.value);

            const actionPayload = {
                command: state,
                reason: state === 'ON' ? `Temperature above ${tempThreshold.toFixed(1)}F threshold` : `Temperature stabilized below ${tempThreshold.toFixed(1)}F`,
                current_temp: temp.toFixed(1),
                system_id: 'Greenhouse-Controller-1', 
                timestamp: new Date().toISOString()
            };

            fetch(FAN_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-System-Source': 'Fan-Tester' },
                body: JSON.stringify(actionPayload)
            })
            .then(response => {
                if (response.ok) {
                    log(`FAN: SUCCESS [${state}] sent to Mockoon. HTTP ${response.status}`);
                    fanState = state; 
                    updateFanStatusDisplay(state); 
                    
                    if (state === 'ON') { 
                         sendEmailAlert('Greenhouse Fan', state, `Temperature reached ${temp.toFixed(1)}°F (Threshold: ${tempThreshold.toFixed(1)}°F).`);
                    }
                    
                } else {
                    log(`FAN: ERROR [${state}] failed. HTTP ${response.status}.`, true);
                }
                return response.json();
            })
            .then(data => { log(`FAN: Mock Response: ${JSON.stringify(data)}`); })
            .catch(error => { log(`FAN: Network Error calling Mockoon: ${error.message}`, true); });
        }

        function sendSprinklerCommand(state, rainfall) {
            const rainfallThreshold = parseFloat(sprinklerThresholdInputEl.value);

            const actionPayload = {
                command: state,
                reason: state === 'ON' ? `Rainfall below ${rainfallThreshold.toFixed(2)}in threshold` : 'Rainfall sufficient, stopping irrigation',
                current_rainfall: rainfall.toFixed(2),
                threshold: rainfallThreshold.toFixed(2),
                system_id: 'Irrigation-Controller-1', 
                timestamp: new Date().toISOString()
            };

            fetch(SPRINKLER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-System-Source': 'Sprinkler-Tester' },
                body: JSON.stringify(actionPayload)
            })
            .then(response => {
                if (response.ok) {
                    log(`SPRINKLER: SUCCESS [${state}] sent to Mockoon. HTTP ${response.status}`);
                    sprinklerState = state; 
                    updateSprinklerStatusDisplay(state); 
                    
                    if (state === 'ON') { 
                         sendEmailAlert('Irrigation System', state, `Rainfall is critically low at ${rainfall.toFixed(2)} in. (Threshold: ${rainfallThreshold.toFixed(2)} in.).`);
                    }

                } else {
                    log(`SPRINKLER: ERROR [${state}] failed. HTTP ${response.status}.`, true);
                }
                return response.json();
            })
            .then(data => { log(`SPRINKLER: Mock Response: ${JSON.stringify(data)}`); })
            .catch(error => { log(`SPRINKLER: Network Error calling Mockoon: ${error.message}`, true); });
        }
        
        // NEW: Send Light Command
        function sendLightCommand(state, reason) {
            const actionPayload = {
                command: state,
                reason: reason,
                system_id: 'Greenhouse-Light-Controller-1', 
                timestamp: new Date().toISOString()
            };

            fetch(LIGHT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-System-Source': 'Light-Tester' },
                body: JSON.stringify(actionPayload)
            })
            .then(response => {
                if (response.ok) {
                    log(`LIGHT: SUCCESS [${state}] sent to Mockoon. HTTP ${response.status}`);
                    lightState = state; 
                    updateLightStatusDisplay(state); 
                    
                    if (state === 'ON') { 
                         sendEmailAlert('Greenhouse Light', state, `Automatic lights turned ON. Reason: ${reason}.`);
                    }

                } else {
                    log(`LIGHT: ERROR [${state}] failed. HTTP ${response.status}. (Ensure '/api/light-control' exists in Mockoon)`, true);
                }
                return response.json();
            })
            .then(data => { log(`LIGHT: Mock Response: ${JSON.stringify(data)}`); })
            .catch(error => { log(`LIGHT: Network Error calling Mockoon: ${error.message}`, true); });
        }


        // --- SYSTEM CHECK & MASTER CONTROL (Combined Weather Fetch) ---

        async function checkWeatherAndSystems() {
            log('Fetching real external weather data from OpenWeatherMap...');
            
            // Read current threshold values from input fields
            const tempThreshold = parseFloat(fanThresholdInputEl.value);
            const rainfallThreshold = parseFloat(sprinklerThresholdInputEl.value);

            try {
                const response = await fetch(WEATHER_API_URL);
                
                if (!response.ok) {
                    throw new Error(`OpenWeatherMap API returned status: ${response.status}`);
                }

                const data = await response.json();
                
                // --- 1. Temperature Logic (FAN CONTROL) ---
                const realTemp = data.main.temp;
                const displayTemp = realTemp.toFixed(1);
                
                currentTempEl.textContent = displayTemp;
                currentTempEl.classList.toggle('text-red-400', realTemp > tempThreshold);
                currentTempEl.classList.toggle('text-blue-400', realTemp <= tempThreshold);

                let newFanState = (realTemp > tempThreshold) ? 'ON' : 'OFF';

                if (newFanState !== fanState) {
                    log(`FAN Logic: State change detected! Temp: ${displayTemp}°F. Threshold: ${tempThreshold}°F.`);
                    sendFanCommand(newFanState, realTemp);
                }

                // --- 2. Rainfall Logic (SPRINKLER CONTROL) ---
                const rain_mm = data.rain && data.rain['1h'] ? data.rain['1h'] : 0;
                
                const realRainfall = rain_mm * MM_TO_INCH; 
                const displayRainfall = realRainfall.toFixed(2);
                
                currentRainfallEl.textContent = displayRainfall;
                currentRainfallEl.classList.toggle('text-green-400', realRainfall > rainfallThreshold);
                currentRainfallEl.classList.toggle('text-blue-400', realRainfall <= rainfallThreshold);

                let newSprinklerState = (realRainfall < rainfallThreshold) ? 'ON' : 'OFF';

                if (newSprinklerState !== sprinklerState) {
                    log(`SPRINKLER Logic: State change detected! Rain: ${displayRainfall} in. Threshold: ${rainfallThreshold.toFixed(2)} in.`);
                    sendSprinklerCommand(newSprinklerState, realRainfall);
                }
                
                // --- 3. Sunrise/Sunset Logic (LIGHT CONTROL) ---
                if (data.sys.sunrise && data.sys.sunset) {
                    const nowTimestamp = Math.floor(Date.now() / 1000); // Current time in seconds (Unix)
                    const sunriseTimestamp = data.sys.sunrise;
                    const sunsetTimestamp = data.sys.sunset;
                    
                    // Convert timestamps to local time strings for display
                    const sunriseTime = new Date(sunriseTimestamp * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
                    const sunsetTime = new Date(sunsetTimestamp * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });

                    sunriseTimeEl.textContent = sunriseTime;
                    sunsetTimeEl.textContent = sunsetTime;

                    // Logic: Light ON when after sunset OR before sunrise
                    // Light OFF otherwise (daytime)
                    let newLightState = 'OFF';
                    let lightReason = 'Daytime';

                    if (nowTimestamp < sunriseTimestamp || nowTimestamp > sunsetTimestamp) {
                        newLightState = 'ON';
                        lightReason = nowTimestamp < sunriseTimestamp ? 'Before Sunrise' : 'After Sunset';
                    }

                    if (newLightState !== lightState) {
                        log(`LIGHT Logic: State change detected! Status: ${newLightState}. Reason: ${lightReason}.`);
                        sendLightCommand(newLightState, lightReason);
                    }
                } else {
                    log('LIGHT API ERROR: Sunrise/Sunset data not found in OpenWeatherMap response.', true);
                    sunriseTimeEl.textContent = 'N/A';
                    sunsetTimeEl.textContent = 'N/A';
                }


            } catch (error) {
                log(`WEATHER API ERROR: Could not fetch weather data: ${error.message}`, true);
                currentTempEl.textContent = 'N/A';
                currentRainfallEl.textContent = 'N/A';
                sunriseTimeEl.textContent = 'N/A';
                sunsetTimeEl.textContent = 'N/A';
            }
        }
        
        function checkAllSystems() {
            log('Running full system check...');
            checkWeatherAndSystems();
        }

        function toggleApiTest() {
            if (intervalId) {
                // Stop the test
                clearInterval(intervalId);
                intervalId = null;
                toggleButton.textContent = 'Start API Test';
                toggleButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                toggleButton.classList.add('bg-green-600', 'hover:bg-green-700');
                log('--- API Test Stopped by User. ---');
            } else {
                // Start the test
                log('--- API Test Started by User. Checking all systems every 5 seconds... ---');
                checkAllSystems();
                intervalId = setInterval(checkAllSystems, CHECK_INTERVAL);
                toggleButton.textContent = 'Stop API Test';
                toggleButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                toggleButton.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        // Initialize the page
        window.onload = () => {
            toggleButton.addEventListener('click', toggleApiTest);
            updateFanStatusDisplay(fanState); 
            updateSprinklerStatusDisplay(sprinklerState); 
            updateLightStatusDisplay(lightState); // Initialize Light status
        };
    </script>
</body>
</html>
